{% extends "recipe_layout.html" %}

{% block base_top_scripts %}

{% endblock %}

<!-- Title of the page -->
{% block title %}
    Add recipe
{% endblock %}

{% block form_start %}
    <form action="/recipes/add" method="post" id="ingredientForm">
{% endblock %}

{% block form_end %}
    </form>
{% endblock %}

<!-- Picture of the food! -->
{% block image %}
    <div class="form-group">
        <div class="img-container rounded drop-shadow">
            <img src={{ url_for('static', filename='img/food.jpg') }}>
            <div class="image-overlay">
                <div class="h2">Change picture</div>
                <p>
                    Click here to upload a new picture!
                </p>
            </div>
        </div>
    </div>
{% endblock %}

<!-- Main heading of a recipe page -->
{% block main_heading %}
    <div class="form-group">
        <p>Title:</p>
        <input data-role="text" class="metro-input" name="The title of your recipe" placeholder="Heading">
    </div>
{% endblock %}

<!-- 
Row with items for how tasty, how difficult the recipe was. Note <li>!
-->
{% block summary_row %}
    <div class="cell-sm" style="min-width:100px;">
        <p>Difficulty:</p>
        <input type="text" data-role="spinner" data-min-value="0" data-max-value="5" name="difficulty">
    </div>
    <div class="cell-sm">
        <p>Taste:</p>
        <input type="text" data-role="spinner" data-min-value="0" data-max-value="5" name="taste">
    </div>
    <div class="cell-sm">
        <p>Time:</p>
        <input data-role="timepicker" data-seconds="false" data-value="00:00" name="time">
    </div>
{% endblock %}

<!-- 
Short information about the recipe, will be just under the summary_row
-->
{% block short_info %}
    <div class="form-group">
        <p>Short info:</p>
        <textarea data-role="textarea" data-auto-size="false" class="metro-input" name="short_info" placeholder="Short information about the recipe" style="min-height:70px; height: 85px;"></textarea>
    </div>
{% endblock %}

<!-- 
Cell for buttons to add prep steps or ingredients.
-->
{% block prep_and_ingredient_buttons %}

    <div class="cell-sm" style="display:flex;justify-content:center">
        <button type="button" class="button primary large" onclick="open_prep_dialog()">Add preparation step</button>
    </div>
    <div class="cell-sm" style="display:flex;justify-content:center">
        <button type="button" class="button primary large" onclick="open_ingredient_dialog()">Add ingredient</button>
    </div>
    <div class="cell-sm" style="display:flex;justify-content:center">
        <button type="button" class="button primary large" onclick="open_steps_dialog()">Add step</button>
    </div>

{% endblock %}
<!-- 
Preparation cell, to the left of the recipe.
-->
{% block prep %}
    <div class="dialog" data-role="dialog" id="prepsDialogBox">
        <div class="dialog-title">Add new preparation step</div>
        <div class="dialog-content">
            <div class="form-group">
                <input type="text" data-role="input" id="prepInputBox" placeholder="Prep description">
            </div>
        </div>
        <div class="dialog-actions">
            <button class="button js-dialog-close" onclick="add_prep_step()">Add</button>
            <button class="button primary js-dialog-close">Cancel</button>
        </div>
    </div>

    <h5>Preparations</h5>
    <ul class="items-list" id="prep_ul">
    </ul>

{% endblock %}

<!-- 
List with ingredients
-->
{% block ingredients %}
    <div class="dialog" data-role="dialog" id="ingredientsDialogBox">
        <div class="dialog-title">Add new ingredient</div>
        <div class="dialog-content">
            <div class="form-group">
                <div class="row">
                    <div class="cell">
                        <input type="text" data-role="input" id="ingredientInputBox" placeholder="Ingredient name" data-autocomplete="">
                    </div>
                </div>
                <div class="row">
                    <div class="cell">
                        <p id="amount_unit">Amount:</p>
                        <input type="text" data-role="spinner" data-min-value="0" name="difficulty" id="amount_spinner">
                    </div>
                    <div class="cell">
                        <div class="form-group" style="max-width: 280px">
                            <p>Unit of measurement:</p>
                            <select data-role="select" name="unit" placeholder="Special notes" id="unit_selector">
                                <optgroup label="Volume">
                                    <option value="l">Liters</option>
                                    <option value="dl">Deciliters</option>
                                    <option value="cl">Centiliters</option>
                                </optgroup>
                                <optgroup label="Mass">
                                    <option value="kg">Kilogram</option>
                                    <option value="hg">Hektogram</option>
                                    <option value="g">Gram</option>
                                </optgroup>
                                <optgroup label="Common measures">
                                    <option value="tbsp">Tablespoon (15ml)</option>
                                    <option value="tsp">Teaspoon (5ml)</option>
                                    <option value="pcs">Pieces</option>
                                </optgroup>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="dialog-actions">
            <button class="button js-dialog-close" onclick="check_ingredient()">Add</button>
            <button class="button primary js-dialog-close">Close</button>
        </div>
    </div>

    <h5>Ingredients</h5>
    <ul class="items-list" id="ingredient_ul">
    </ul>
{% endblock %}

<!-- 
List with all the steps that needs to be done.


-->
{% block step_list %}
    <div class="dialog" data-role="dialog" id="stepsDialogBox">
        <div class="dialog-title">Add new step</div>
        <div class="dialog-content">
            <div class="form-group">
                <p>Short info:</p>
                <textarea data-role="textarea" data-auto-size="false" class="metro-input" placeholder="Describe your step" style="min-height:70px; height: 85px;" id="stepsInputBox"></textarea>
            </div>
        </div>
        <div class="dialog-actions">
            <button class="button js-dialog-close" onclick="add_recipe_step()">Add</button>
            <button class="button primary js-dialog-close">Cancel</button>
        </div>
    </div>
    <h5>Steps</h5>
    <ul class="step-list" id="recipeStepList">
    </ul>
{% endblock %}

{% block submit %}
    <div class="cell">
        <div class="d-flex flex-justify-center">
            <button type="button" class="button primary large shadowed" style="margin: 20px; width: 30%" onClick="submit_form()">Add recipe</button>
        </div>
    </div>
{% endblock %}

<!-- 
Scripts!
-->
{% block base_bottom_scripts %}
<script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
<script>
    steps_array = ["First", "Second", "Third", "Fourth", "Fift", "Sixth", "Seventh", "Eighth", "Nineth", "Tenth", "Eleventh", ]
    function open_ingredient_dialog(){
        // Opens up the dialog for adding ingredients
        Metro.dialog.open('#ingredientsDialogBox');
    }

    function open_prep_dialog(){
        // Opens up the dialog for adding prep items
        Metro.dialog.open('#prepsDialogBox');
    }

    function open_steps_dialog(){
        // Opens up the dialog for adding steps
        Metro.dialog.open('#stepsDialogBox');
    }

    function create_hidden_input(name, value){
        //<input type="hidden" value="None" id="ingredient_type" name="type">
        // ingredient_input
        input = document.createElement('input');
        input.type = "hidden";
        input.name = name;
        input.value = value;
        return input;
    }

    function add_prep_step(){
        // Function that executes when you press the 'add'-button for the preps
        text = $("#prepInputBox").val();
        list_item = create_list_element(text)

        hidden_input = create_hidden_input(
                name="prep_input",
                value="{'text':" + text + "}"
            )
        list_item.appendChild(hidden_input);
        $("#prep_ul").append(list_item);
    }

    function add_recipe_step(){
        // Function that executes when you press the 'add'-button for the steps
        text = $("#stepsInputBox").val();
        $("#stepsInputBox").val("");

        list_item = document.createElement("li");

        heading = document.createElement("h4");
        count = $("#recipeStepList")[0].childElementCount;
        heading.textContent = steps_array[count] + " step";

        content = document.createElement("p");
        content.textContent = text;

        list_item.appendChild(heading);
        list_item.appendChild(content);
        $("#recipeStepList").append(
            list_item
        );
    }

    function ingredient_callback_ok(response){
        if (response == true){
            list_item = create_list_element(
                ingredient_name, {"amount":$("#amount_spinner").val(), "unit":$("#unit_selector").val()}
            );

            // Create a hidden input for all list items so they will be submitted.
            hidden_input = create_hidden_input(
                name="ingredient_input",
                value="{'name':" + ingredient_name + ",'amount':" + $("#amount_spinner").val() + ", 'unit':" + $("#unit_selector").val() + "}"
            )

            list_item.appendChild(hidden_input);

            // Must use [0] as $("#ingredient_ul") returns a list with only one value
            $("#ingredient_ul")[0].append(list_item);
            
            // Clear the input box        
            $("#ingredientInputBox").val("");
        }
        else{
                alert(ingredient_name + " was not found!");
            }
    }

    function ingredient_callback_nok(response){
        alert("Internal Server Error!");
    }

    function check_ingredient(){
        ingredient_name = $("#ingredientInputBox").val();
        $.ajax({
            method: "GET",
            url: "/ingredients/check?q=" + ingredient_name,
        }).then(ingredient_callback_ok, ingredient_callback_nok);
    }

    // Append a new LI item to the UL for ingredients. Values need to be verified against the database first.
    // Using an Ajax-call to check the value in the text input when trying to add the new LI.
    $("#ingredientInputBox").keyup(function(event){
        input_el = Metro.getPlugin("#ingredientInputBox",'input');

        if (event.keyCode === 13) {
            check_ingredient();
        }
        if(this.value.length >= 1){
            $.get("/ingredients?q=" + this.value, function(ingredients){
                console.log(ingredients);
                input_el.autocomplete = ingredients;
            })
        }
    })

    function create_span(span_class, text=""){
        let span = document.createElement("span");
        span.className = span_class;
        if (text != ""){
            span.textContent = text;
        }
        return span;
    }

    function add_remove_button(element){
        remove_button = create_span("second-action fas fa-times fg-red");
        remove_button.onclick = function() { console.log(this.parentElement.remove()); };
        element.appendChild(remove_button);
    }

    function create_list_element(label, second_label={}){
        // Creating a list item
        let element = document.createElement("li");

        // Creating a span for 'label'. If list-item should be an ingredient, also put amount and unit as second-label
        element.appendChild(create_span("label", label))

        if (Object.entries(second_label).length != 0){
            element.appendChild(create_span("second-label", second_label.amount + " " + second_label.unit));
        }

        // Add a button that enables it to remove the list-item
        add_remove_button(element);
        return element;
    }

    function submit_form(){
        document.getElementById("ingredientForm").submit();
    }

</script>
{% endblock %}
