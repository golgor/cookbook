{% extends "recipe_layout.html" %}

{% block base_top_scripts %}
<script>
    var append_prep_item = [
        {
            html: "<i class='fas fa-plus'></i>",
            cls: "fg-blue",
            onclick: "append_prep"
        }
    ]
    var append_ingredient_item = [
        {
            html: "<i class='fas fa-plus'></i>",
            cls: "fg-blue",
            onclick: "append_ingredient"
        }
    ]
    var remove_prep_item = [
        {
            html: "<i class='fas fa-times'></i>",
            cls: "fg-red",
            onclick: "remove_item"
        }
    ]
    var remove_ingredient_item = [
        {
            html: "<i class='fas fa-times'></i>",
            cls: "fg-red",
            onclick: "remove_item"
        }
    ]

</script>
{% endblock %}

<!-- Title of the page -->
{% block title %}
    Add recipe
{% endblock %}

{% block form_start %}
    <form action="/recipes/add" method="post" id="ingredientForm">
{% endblock %}

{% block form_end %}
    </form>
{% endblock %}

<!-- Picture of the food! -->
{% block image %}
    <div class="form-group">
        <div class="img-container rounded drop-shadow">
            <img src={{ url_for('static', filename='img/food.jpg') }}>
            <div class="image-overlay">
                <div class="h2">Change picture</div>
                <p>
                    Click here to upload a new picture!
                </p>
            </div>
        </div>
    </div>
{% endblock %}

<!-- Main heading of a recipe page -->
{% block main_heading %}
    <div class="form-group">
        <input data-role="text" class="metro-input" name="heading" placeholder="Heading">
    </div>
{% endblock %}

<!-- 
Row with items for how tasty, how difficult the recipe was. Note <li>!
-->
{% block summary_row %}
    <div class="cell-sm" style="min-width:100px;">
        <label>Difficulty</label>
        <input type="text" data-role="spinner" data-min-value="0" data-max-value="5" name="difficulty">
    </div>
    <div class="cell-sm">
        <label>Taste</label>
        <input type="text" data-role="spinner" data-min-value="0" data-max-value="5" name="taste">
    </div>
    <div class="cell-sm">
        <label>Time</label>
        <input data-role="timepicker" data-seconds="false" data-value="00:00" name="time">
    </div>
{% endblock %}

<!-- 
Short information about the recipe, will be just under the summary_row
-->
{% block short_info %}
    <div class="form-group">
        <textarea data-role="textarea" data-auto-size="false" class="metro-input" name="short_info" placeholder="Heading" style="min-height:70px; height: 85px;"></textarea>
    </div>
{% endblock %}
<!-- 
Preparation cell, to the left of the recipe.
-->
{% block prep %}
    <h5>Preparations</h5>
    <ul class="items-list" id="prep_ul">
        <input type="text" data-role="input" data-clear-button="false" data-custom-buttons="append_prep_item" name="prep_input" placeholder="Add new step">
    </ul>

{% endblock %}

<!-- 
List with ingredients
-->
{% block ingredients %}
    <h5>Ingredients</h5>
    <ul class="items-list" id="ingredient_ul">
        <input type="text" data-role="input" data-clear-button="false" data-custom-buttons="append_ingredient_item" name="ingredient_input" id="ingredientInputBox" placeholder="Add new step" data-autocomplete="">
    </ul>
{% endblock %}

<!-- 
List with all the steps that needs to be done.
-->
{% block step_list %}
    <li>
        Lorem Ipsum is simply dummy text of the printing and typesetting industry.
        Lorem Ipsum has been the industry's standard dummy text ever since the 1500s,
        when an unknown printer took a galley of type and scrambled it to make a type
        specimen book.
    </li>
    <li>
        Contrary to popular belief, Lorem Ipsum is not simply random text.
        It has roots in a piece of classical Latin literature from 45 BC,
        making it over 2000 years old.
    </li>
    <li>
        There are many variations of passages of Lorem Ipsum available,
        but the majority have suffered alteration in some form, by injected
        humour, or randomised words which don't look even slightly believable.
        If you are going to use a passage of Lorem Ipsum, you need to be sure
        there isn't anything embarrassing hidden in the middle of text.
    </li>
    <li>
        There are many variations of passages of Lorem Ipsum available,
        but the majority have suffered alteration in some form, by injected
        humour, or randomised words which don't look even slightly believable.
        If you are going to use a passage of Lorem Ipsum, you need to be sure
        there isn't anything embarrassing hidden in the middle of text.
    </li>
{% endblock %}

{% block submit %}
    <div class="cell">
        <div class="d-flex flex-justify-center">
            <button type="button" class="button primary large shadowed" style="margin: 20px; width: 30%" onClick="submit_form()">Add recipe</button>
        </div>
    </div>
{% endblock %}

<!-- 
Scripts!
-->
{% block base_bottom_scripts %}
<script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
<script>
    prep_ul = document.querySelector("#prep_ul")
    ingr_ul = document.querySelector("#ingredient_ul")
    search_box = document.querySelector("#ingredientSearchbox")

    // Creating a new input node according to below (input element from Metro_4):
    // <input type="text" data-role="input" data-clear-button="false" data-custom-buttons="remove_button" id="prep_input">
    function create_input(text, elementName, buttonName){
        let element = document.createElement("input")
        element.type = "text";
        element.name = elementName;
        element.value = text;
        element.setAttribute("data-role", "input");
        element.setAttribute("data-clear-button", "false");
        element.setAttribute("data-custom-buttons", buttonName);
        element.setAttribute("readonly", "true")
        return element;
    }

    // this refers to the actual button, but in this case we want to remove the div containing both the button and the actual text field.
    function remove_item(){
        this.parentElement.parentElement.remove()
    }

    // Append a new LI item to the UL
    function append_prep(){
        // this refers to the button that is pressed, the parent of this button has a sibling which is the actual input-node.
        // Get the text from this (the current input field) and set it to the newly created input field.
        text = this.parentElement.previousSibling.value;

        // Remove the text in this, text will be "moved" to the LI under it.
        this.parentElement.previousSibling.value = "";

        // Set focus to the input field on top. Easier to append more LIs
        this.parentElement.previousSibling.focus();

        // function to create a new input node
        input = create_input(text, "prep_input", "remove_prep_item");

        // Append the new node to the UL. Inserting before childElementCount would put the new element in the bottom.
        // We want to put the new element above "this" but under previously created inputs, thus -1.
        prep_ul.insertBefore(input, prep_ul.childNodes[prep_ul.childElementCount-1]);
    }


    // Append a new LI item to the UL for ingredients. Values need to be verified against the database first.
    // Using an Ajax-call to check the value in the text input when trying to add the new LI.
    function append_ingredient(){
        ingredient_input = $("#ingredientInputBox")
        ingredient_name = ingredient_input.val();
        ingr_ul = $("#ingredient_ul")[0];
        $.ajax({
            method: "GET",
            url: "/ingredients/check?q=" + ingredient_name,
        }).then(function (response){
            if (response == true){
                input = create_input(ingredient_name, "ingredient_input", "remove_ingredient_item");
                ingr_ul.insertBefore(input, ingr_ul.childNodes[ingr_ul.childElementCount-1]);
                ingredient_input.val("");
                ingredient_input.focus();
            }
            else{
                alert(ingredient_name + " was not found!");
            }
        }, function (xhr) {
            console.log(xhr.response);
        })
    }

    $("#ingredientInputBox").keyup(function(event){
        input_el = Metro.getPlugin("#ingredientInputBox",'input');

        if (event.keyCode === 13) {
            append_ingredient();
        }
        if(this.value.length >= 1){
            $.get("/ingredients?q=" + this.value, function(ingredients){
                console.log(ingredients);
                input_el.autocomplete = ingredients;
            })
        }
    })

    function submit_form(){
        document.getElementById("ingredientForm").submit();
    }

</script>
{% endblock %}
